pipeline:
  build:
    image: quay.io/reddit/reddit-nodejs:latest
    pull: true
    commands:
      - npm install
      - npm run lint
      - npm run test
      - npm run build


  publish:
    image: plugins/docker
    username: ${QUAY_USERNAME}
    password: ${QUAY_PASSWORD}
    email: sysops@reddit.com
    registry: quay.io
    repo: quay.io/reddit/reddit-mobile
    tag: ${DRONE_BRANCH}
    dockerfile: Dockerfile.staging

  deploy:
    image: lachlanevenson/k8s-helm:v2.4.2
    commands:
      - helm upgrade ${DRONE_BRANCH} helm/reddit-mobile --install --set=deployment_name="${DRONE_BRANCH}" --set=branch_name="${DRONE_BRANCH}" --set=commit_sha="${DRONE_COMMIT}" --set=deployer_name="${DRONE_COMMIT_AUTHOR}" --set=service_name="${DRONE_BRANCH}"
    volumes:
      - /root/.kube/config:/root/.kube/config
